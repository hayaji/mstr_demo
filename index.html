<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>MSTR Dossier Embed (Identity Token ile)</title>

  <style>
    #mydossier {
      border: 1px solid #ccc;
      margin-top: 10px;
    }
  </style>

  <!-- 1. Ã–nce global ayarlarÄ± tanÄ±mla -->
  <script>
    const BASE_URL    = 'https://report.diasteknoloji.com/MicroStrategyLibrary';
    const USERNAME    = 'portaldbys.user';
    const PASSWORD    = 'Aa123456';  // â›” GerÃ§ek sistemde tarayÄ±cÄ±da kullanma!
    const DOSSIER_URL = 'https://report.diasteknoloji.com/MicroStrategyLibrary/app/B1AE84B54741CE143087C3B900E29D47/FD3757D7439EC2DC7E1A3692AC22CF89';

    // Token'Ä± Ã¶nceden alÄ±p dÄ±ÅŸarÄ±dan ulaÅŸÄ±labilir hale getir
    let globalIdentityToken = '';

    // Header olarak identity token gÃ¶ndermek iÃ§in config
    window.mstrAppConfig = {
      customHeaders: [
        {
          name: "X-MSTR-IdentityToken",
          value: async () => {
            console.log("ğŸ”„ Header iÃ§in identity token hazÄ±rlanÄ±yor...");
            return globalIdentityToken;
          }
        }
      ]
    };

    /** ğŸ§  1. Oturum aÃ§ ve identityToken al **/
    async function fetchIdentityToken() {
      console.log("ğŸ” KullanÄ±cÄ± ile giriÅŸ yapÄ±lÄ±yor...");

      // 1) GiriÅŸ
      const loginRes = await fetch(`${BASE_URL}/api/auth/login`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username: USERNAME, password: PASSWORD, loginMode: 1 })
      });

      if (!loginRes.ok) {
        console.error("âŒ GiriÅŸ baÅŸarÄ±sÄ±z. HTTP kodu:", loginRes.status);
        throw new Error(`GiriÅŸ baÅŸarÄ±sÄ±z: ${loginRes.status}`);
      }

      const authToken = loginRes.headers.get('X-MSTR-AuthToken');
      console.log("âœ… GiriÅŸ baÅŸarÄ±lÄ±. AuthToken alÄ±ndÄ±:", authToken);

      // 2) Identity Token al
      console.log("ğŸ”„ Identity token alÄ±nÄ±yor...");
      const idRes = await fetch(`${BASE_URL}/api/auth/identityToken`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-MSTR-AuthToken': authToken
        }
      });

      if (!idRes.ok) {
        console.error("âŒ Identity token alÄ±namadÄ±. HTTP kodu:", idRes.status);
        throw new Error(`Identity token alÄ±namadÄ±: ${idRes.status}`);
      }

      const { identityToken } = await idRes.json();
      console.log("âœ… Identity token alÄ±ndÄ±:", identityToken);
      return identityToken;
    }
  </script>

  <!-- 2. SDKâ€™yÄ± sonradan yÃ¼kle -->
  <script src="https://report.diasteknoloji.com/MicroStrategyLibrary/javascript/embeddinglib.js"></script>
</head>
<body>
  <h3>Embed AlanÄ±:</h3>
  <div id="mydossier"></div>

  <script>
    // 3. Sayfa yÃ¼klendiÄŸinde iÅŸlem baÅŸlasÄ±n
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log("ğŸš€ Sayfa yÃ¼klendi. Token alma iÅŸlemi baÅŸlÄ±yor...");
        const token = await fetchIdentityToken();
        globalIdentityToken = token; // Header iÃ§in dÄ±ÅŸa aktar

        // Embed iÅŸlemi
        console.log("ğŸ“¦ Dossier embed iÅŸlemi baÅŸlatÄ±lÄ±yor...");
        await microstrategy.dossier.create({
          url: DOSSIER_URL,
          placeholder: document.getElementById('mydossier'),
          containerHeight: '1000px',
          enableResponsive: true,
          enableCustomAuthentication: true,
          customAuthenticationType:
            microstrategy.dossier.CustomAuthenticationType.IDENTITY_TOKEN,
          getLoginToken: () => {
            console.log("â¡ï¸ Embed'e identity token veriliyor.");
            return Promise.resolve(token);
          }
        });

        console.log("âœ… Dossier baÅŸarÄ±yla embed edildi.");
      } catch (err) {
        console.error("âŒ Bir hata oluÅŸtu:", err);
        alert("Hata: " + err.message);
      }
    });
  </script>
</body>
</html>
