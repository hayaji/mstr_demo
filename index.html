<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>MicroStrategy Embedded Dossier</title>
    <script
      type="text/javascript"
      src="https://report.diasteknoloji.com/MicroStrategyLibrary/javascript/embeddinglib.js"
    ></script>
  </head>
  <body>
    <div>Embed Alanı:</div>
    <div id="mydossier" style="border: 1px solid #ccc; margin-top: 10px;"></div>

    <script>
      async function fetchIdentityToken() {
        try {
          const response = await fetch(
            "https://report.diasteknoloji.com/MicroStrategyLibrary/api/auth/identityToken",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({
                // Geçerli bir token ile login olunması gerekir
                loginMode: 1, 
                username: "report.developer",
                password: "Dias*123",
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`Sunucudan cevap alınamadı: ${response.status}`);
          }

          const data = await response.json();
          const identityToken = data.token; // Burada dönen token'ı alıyoruz
          
          console.log("🔐 Identity Token başarıyla alındı:", identityToken);
          return identityToken;
        } catch (error) {
          console.error("❌ Token alma hatası:", error);
          throw error;
        }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        try {
          const token = await fetchIdentityToken(); // Token'ı alıyoruz

          const container = document.getElementById("mydossier");
          const dossierUrl =
            "https://report.diasteknoloji.com/MicroStrategyLibrary/app/B1AE84B54741CE143087C3B900E29D47/FD3757D7439EC2DC7E1A3692AC22CF89";

          microstrategy.dossier
            .create({
              url: dossierUrl,
              placeholder: container,
              containerHeight: "1000px",
              enableResponsive: true,
              enableCustomAuthentication: true,
              customAuthenticationType:
                microstrategy.dossier.CustomAuthenticationType.IDENTITY_TOKEN,
              getLoginToken: () => {
                console.log("📦 Embed'e token gönderiliyor...");
                return Promise.resolve(token); // Burada alınan token'ı kullanıyoruz
              },
            })
            .then((dossier) => {
              console.log("✅ Embed işlemi başarılı:", dossier);
            })
            .catch((err) => {
              console.error("❌ Embed sırasında hata:", err);
            });
        } catch (e) {
          alert("Token alınamadığı için embed işlemi başarısız oldu.");
        }
      });
    </script>
  </body>
</html>
