<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>MicroStrategy Embedded Dossier</title>
    <script
      type="text/javascript"
      src="https://report.diasteknoloji.com/MicroStrategyLibrary/javascript/embeddinglib.js"
    ></script>
  </head>
  <body>
    <div>Embed AlanÄ±:</div>
    <div id="mydossier" style="border: 1px solid #ccc; margin-top: 10px;"></div>

    <script>
      async function fetchIdentityToken() {
        try {
          const response = await fetch(
            "https://report.diasteknoloji.com/MicroStrategyLibrary/api/auth/identityToken",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify({
                // GeÃ§erli bir token ile login olunmasÄ± gerekir
                loginMode: 1, 
                username: "report.developer",
                password: "Dias*123",
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`Sunucudan cevap alÄ±namadÄ±: ${response.status}`);
          }

          const data = await response.json();
          const identityToken = data.token; // Burada dÃ¶nen token'Ä± alÄ±yoruz
          
          console.log("ğŸ” Identity Token baÅŸarÄ±yla alÄ±ndÄ±:", identityToken);
          return identityToken;
        } catch (error) {
          console.error("âŒ Token alma hatasÄ±:", error);
          throw error;
        }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        try {
          const token = await fetchIdentityToken(); // Token'Ä± alÄ±yoruz

          const container = document.getElementById("mydossier");
          const dossierUrl =
            "https://report.diasteknoloji.com/MicroStrategyLibrary/app/B1AE84B54741CE143087C3B900E29D47/FD3757D7439EC2DC7E1A3692AC22CF89";

          microstrategy.dossier
            .create({
              url: dossierUrl,
              placeholder: container,
              containerHeight: "1000px",
              enableResponsive: true,
              enableCustomAuthentication: true,
              customAuthenticationType:
                microstrategy.dossier.CustomAuthenticationType.IDENTITY_TOKEN,
              getLoginToken: () => {
                console.log("ğŸ“¦ Embed'e token gÃ¶nderiliyor...");
                return Promise.resolve(token); // Burada alÄ±nan token'Ä± kullanÄ±yoruz
              },
            })
            .then((dossier) => {
              console.log("âœ… Embed iÅŸlemi baÅŸarÄ±lÄ±:", dossier);
            })
            .catch((err) => {
              console.error("âŒ Embed sÄ±rasÄ±nda hata:", err);
            });
        } catch (e) {
          alert("Token alÄ±namadÄ±ÄŸÄ± iÃ§in embed iÅŸlemi baÅŸarÄ±sÄ±z oldu.");
        }
      });
    </script>
  </body>
</html>
